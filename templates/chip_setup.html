<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Chip Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; padding: 40px 0; }
        .chip-card { background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 15px; text-align: center; transition: 0.3s; height: 100%; }
        .chip-card.active { border-color: #28a745; background: #1b2e1e; }
        .chip-img-l { width: 50px; height: 50px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .form-check-input:checked { background-color: #28a745; border-color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-5 fw-light">Chip Values & Selection</h2>
        <form id="setupForm">
            <div class="row g-4" id="chipsContainer"></div>
            <div class="text-center mt-5">
                <a href="/" class="btn btn-outline-secondary px-4 me-2">Cancel</a>
                <button type="button" id="resetBtn" class="btn btn-outline-warning px-4 me-2">Reset to Defaults</button>
                <button type="submit" class="btn btn-success px-5">Save Settings</button>
            </div>
        </form>
    </div>
    <script>
        const DEFAULT_CHIP_VALUES = {{ chip_values|tojson }};
        const DEFAULT_SELECTED_CHIPS = {{ selected_chips|tojson }};
        const ALL_CHIPS = {{ all_chips|tojson }};
        
        // Load from localStorage or use defaults
        let chipValues = JSON.parse(localStorage.getItem('chipValues')) || DEFAULT_CHIP_VALUES;
        let selectedChips = JSON.parse(localStorage.getItem('selectedChips')) || DEFAULT_SELECTED_CHIPS;
        
        // Render chips
        const container = document.getElementById('chipsContainer');
        container.innerHTML = ALL_CHIPS.map(chip => `
            <div class="col-6 col-md-3">
                <div class="chip-card ${selectedChips.includes(chip) ? 'active' : ''}" id="card-${chip}">
                    <input type="checkbox" class="form-check-input chip-toggle" data-chip="${chip}" ${selectedChips.includes(chip) ? 'checked' : ''}>
                    <div class="mt-2"><img src="/static/${chip}-chip.jpg" class="chip-img-l"></div>
                    <div class="small text-muted text-uppercase mb-2">${chip}</div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-dark border-secondary">$</span>
                        <input type="number" class="form-control bg-dark text-white border-secondary text-center" id="val-${chip}" value="${chipValues[chip]}" step="0.01">
                    </div>
                </div>
            </div>
        `).join('');
        
        // Toggle active state
        document.querySelectorAll('.chip-toggle').forEach(el => {
            el.onchange = (e) => {
                e.target.closest('.chip-card').classList.toggle('active', e.target.checked);
            };
        });

        // Reset button
        document.getElementById('resetBtn').onclick = () => {
            if (confirm('Reset all chip values to defaults? This cannot be undone.')) {
                localStorage.removeItem('chipValues');
                localStorage.removeItem('selectedChips');
                window.location.reload();
            }
        };

        // Save to localStorage
        document.getElementById('setupForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const newChipValues = {};
            const newSelectedChips = [];
            
            ALL_CHIPS.forEach(chip => {
                newChipValues[chip] = parseFloat(document.getElementById(`val-${chip}`).value);
            });
            
            document.querySelectorAll('.chip-toggle:checked').forEach(el => {
                newSelectedChips.push(el.dataset.chip);
            });
            
            // Save to localStorage
            localStorage.setItem('chipValues', JSON.stringify(newChipValues));
            localStorage.setItem('selectedChips', JSON.stringify(newSelectedChips));
            
            // Also send to server (optional, for compatibility)
            await fetch('/save-chip-values', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chip_values: newChipValues, selected_chips: newSelectedChips })
            });
            
            window.location.href = '/';
        };
    </script>
</body>
</html>